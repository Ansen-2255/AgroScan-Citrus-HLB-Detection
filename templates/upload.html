<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CitrusCare AI - Analyze</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body {
    background-color: #ffffff;
    font-family: 'Inter', sans-serif;
    margin: 0;
    min-height: 100vh;
}

/* NAVBAR */
.navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 60px;
}

.logo {
    display: flex;
    align-items: center;
    text-decoration: none;
}

.logo-box {
    padding: 5px 10px;
    border-radius: 8px;
    color: white;
    margin-right: 10px;
}

.logo-text {
    color: #123b2a;
    font-weight: 700;
    font-size: 24px;
}

.try-btn {
    background: #123b2a;
    color: white;
    padding: 10px 20px;
    border-radius: 999px;
    text-decoration: none;
    font-size: 13px;
}

/* MAIN CONTAINER */
.upload-container {
    max-width: 800px;
    margin: 60px auto;
    text-align: center;
    padding: 40px;
}

h1 {
    font-size: 48px;
    font-weight: 800;
    color: #1F2937;
}

p {
    color: #6B7280;
    margin-bottom: 30px;
}

/* BUTTON ROW */
.button-row {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 14px;
}

/* UPLOAD BUTTON */
.btn-analyze {
    background-color: #3B82F6;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 15px 40px;
    font-weight: 700;
    cursor: pointer;
    font-size: 16px;
    transition: 0.3s;
}

.btn-analyze:hover {
    background-color: #2563EB;
    transform: scale(1.05);
}

/* CAMERA ICON BUTTON */
.icon-btn {
    background: #123b2a;
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: 0.3s;
}

.icon-btn:hover {
    transform: scale(1.1);
}

/* IMAGE PREVIEW */
.preview-img {
    max-width: 300px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    display: none;
    margin: 30px auto;
    animation: float 3.5s ease-in-out infinite;
}

@keyframes float {
    0% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
    100% { transform: translateY(0); }
}

/* RESULT */
#result-box {
    margin-top: 30px;
    padding: 20px;
    border-radius: 12px;
    display: none;
    text-align: left;
}

.alert-success {
    background-color: #dcfce7;
    color: #166534;
}

.alert-danger {
    background-color: #fee2e2;
    color: #991b1b;
}


/* Chatbot Button */
#chatbot-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #2ecc71;
  color: white;
  width: 55px;
  height: 55px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  z-index: 999;
}

/* Chatbot Window */
#chatbot {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 320px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: 999;
}

.chat-header {
  background: #2ecc71;
  color: white;
  padding: 12px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
}

.chat-body {
  padding: 10px;
  height: 250px;
  overflow-y: auto;
  font-size: 14px;
}

.chat-body .bot {
  background: #f1f1f1;
  padding: 8px;
  border-radius: 8px;
  margin-bottom: 6px;
}

.chat-body .user {
  background: #2ecc71;
  color: white;
  padding: 8px;
  border-radius: 8px;
  margin-bottom: 6px;
  text-align: right;
}

.chat-input {
  display: flex;
  border-top: 1px solid #ddd;
}

.chat-input input {
  flex: 1;
  padding: 10px;
  border: none;
  outline: none;
}

.chat-input button {
  background: #2ecc71;
  color: white;
  border: none;
  padding: 0 15px;
  cursor: pointer;
}

#chatbot-close {
  cursor: pointer;
}
</style>
</head>

<body>

<header class="navbar">
    <a href="/" class="logo">
        <span class="logo-box">üåø</span>
        <span class="logo-text">AgroScan</span>
    </a>

    <a href="{{ url_for('detect') }}" class="try-btn">Back</a>
</header>

<div class="upload-container">
    <h1>Analyze Citrus Leaf</h1>
    <p>Identify citrus diseases instantly using Vision Transformers.</p>

    <!-- HIDDEN INPUT (UPLOAD + CAMERA) -->
    <input 
        type="file"
        id="imageInput"
        accept="image/*"
        capture="environment"
        style="display:none"
        onchange="previewImage(event)"
    >

    <!-- BUTTONS -->
    <div class="button-row">
        <button class="btn-analyze" onclick="document.getElementById('imageInput').click()">
            <i class="fa-solid fa-cloud-arrow-up"></i> UPLOAD IMAGE
        </button>

        <button class="icon-btn" onclick="document.getElementById('imageInput').click()" title="Take Photo">
            <i class="fa-solid fa-camera"></i>
        </button>
    </div>

    <img id="imagePreview" class="preview-img">

    <div id="loading" style="display:none; color:#3B82F6; margin-top:20px;">
        <i class="fa-solid fa-spinner fa-spin"></i> Vision Transformer is scanning patterns...
    </div>

    <div id="result-box">
        <h3 id="result-title"></h3>
        <p id="result-confidence"></p>
        <div id="recommendation"></div>
    </div>
</div>

<script>
function previewImage(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = document.getElementById("imagePreview");
        img.src = e.target.result;
        img.style.display = "block";
        runAnalysis(file);
    };
    reader.readAsDataURL(file);
}

async function runAnalysis(file) {
    document.getElementById("loading").style.display = "block";
    document.getElementById("result-box").style.display = "none";

    const formData = new FormData();
    formData.append("file", file);

    try {
        const res = await fetch("/predict", {
            method: "POST",
            body: formData
        });

        const data = await res.json();

        document.getElementById("loading").style.display = "none";
        const box = document.getElementById("result-box");
        box.style.display = "block";

        document.getElementById("result-title").innerText =
            `Analysis Result: ${data.prediction}`;

        document.getElementById("result-confidence").innerText =
            `Confidence: ${data.confidence}`;

        if (data.prediction === "Healthy") {
            box.className = "alert-success";
            document.getElementById("recommendation").innerHTML =
                "This leaf shows no signs of disease.";
        } else {
            box.className = "alert-danger";
            document.getElementById("recommendation").innerHTML =
                "Disease detected. Quarantine and consult an expert.";
        }
    } catch {
        alert("Error connecting to server");
    }
}
</script>

<!-- Chatbot Button -->
<div id="chatbot-toggle">
  <i class="fa-solid fa-comments"></i>
</div>

<!-- Chatbot Window -->
<div id="chatbot">
  <div class="chat-header">
    üå± AgroScan Bot
    <span id="chatbot-close">&times;</span>
  </div>

  <div class="chat-body" id="chat-body">
    <div class="bot">Hi üëã I‚Äôm AgroScan Bot. How can I help you?</div>
  </div>

  <div class="chat-input">
    <input type="text" id="user-input" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
const chatbot = document.getElementById("chatbot");
const toggleBtn = document.getElementById("chatbot-toggle");
const closeBtn = document.getElementById("chatbot-close");
const chatBody = document.getElementById("chat-body");

toggleBtn.onclick = () => {
  chatbot.style.display =
    chatbot.style.display === "flex" ? "none" : "flex";
};

closeBtn.onclick = () => {
  chatbot.style.display = "none";
};

async function sendMessage() {
  const input = document.getElementById("user-input");
  const msg = input.value.trim();
  if (!msg) return;

  chatBody.innerHTML += `<div class="user">${msg}</div>`;
  input.value = "";

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: msg })
    });

    const data = await res.json();
    chatBody.innerHTML += `<div class="bot">${data.reply}</div>`;
    chatBody.scrollTop = chatBody.scrollHeight;

  } catch {
    chatBody.innerHTML += `<div class="bot">‚ö†Ô∏è Server not running</div>`;
  }
}

const inputField = document.getElementById("user-input");

inputField.addEventListener("keydown", function (event) {
  if (event.key === "Enter") {
    event.preventDefault(); // prevent line break
    sendMessage();
  }
});
</script>

</body>
</html>
